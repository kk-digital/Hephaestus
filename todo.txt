# Hephaestus Development TODO
# Updated: 2025-11-04

## Current Session (2025-11-04)

[DONE] Fix all dependency issues (SQLAlchemy, requests, LangChain imports)
    - Upgraded SQLAlchemy to 2.0.44 (Python 3.13 compatible)
    - Fixed requests version conflict (>=2.31.0)
    - Updated LangChain imports (langchain.schema → langchain_core.documents)
    - Added missing test dependencies
    - All 449 tests now collected successfully

[DONE] Create comprehensive .env.example with three-part configuration
    - Part 1: Claude Code LLM Provider (Anthropic subscription/Zai/API)
    - Part 2: Embedding Provider (OpenAI or LM Studio with nomic-embed-text-v1.5)
    - Part 3: Code Review Provider (LM Studio with gptoss120/gpt20, or Groq)
    - Default: LM Studio for code review

[DONE] Create INSTALLATION.txt with troubleshooting documentation
    - Complete installation steps
    - Troubleshooting for all 5 dependency issues
    - Verification procedures

[DONE] Update .claude/CLAUDE.md with process management guidelines
    - Added graceful shutdown requirements
    - Added restart procedures after code changes

[DONE] Create 251104-task-09-graceful-shutdown.txt
    - Health endpoints: GET /health/live, GET /health/status
    - Shutdown endpoints: POST /health/shutdown, POST /health/shutdown/schedule
    - MinIO-style health check patterns
    - Dependency health tracking with success/failure timestamps and counters
    - Signal handling (SIGTERM/SIGINT)
    - Resource cleanup functions

[DONE] Create PR #1 and merge to main
    - https://github.com/kk-digital/Hephaestus/pull/1
    - Merged successfully
    - Both GitHub and Gogs synchronized

[DONE] Check if task-08-sql-wrapper exists (SQL module centralization)
    - CONFIRMED: tasks/251101-task-08-sql-wrapper.txt exists
    - Wraps all SQL operations in C1-level module (c1_database)
    - Forces all SQL commands through wrapped functions
    - STATUS: Pending implementation (6-8 hours estimated)

[DONE] Export session prompts to prompt-export directory
    - Created export-prompts-06.txt with current session prompts

[DONE] Update README.md with .env setup instructions
    - Added prominent "Quick Setup" section
    - Explains cp .env.example .env requirement
    - Clarifies why .env is not committed (secrets)
    - Links to INSTALLATION.txt for full details

[DONE] Create task-10: LM Studio embedding provider support
    - Add LM Studio as embedding provider option (alongside OpenAI)
    - Default to jina-embeddings-v4-text-retrieval (best for retrieval)
    - Alternative: text-embedding-qwen3-embedding-8b (highest quality)
    - Fallback: nomic-embed-text-v1.5 (good quality, 768-dim)
    - See: tasks/251104-task-10-lmstudio-embedding-support.txt

[DONE] Create task-11: Embedding wrapper module centralization
    - Wrap ALL embedding provider calls in single module
    - Similar to task-08 (SQL wrapper pattern)
    - Support OpenAI and LM Studio providers
    - See: tasks/251104-task-11-embedding-wrapper-module.txt

[DONE] Create task-12: Fix deprecation warnings
    - Fix SQLAlchemy declarative_base import (MovedIn20Warning)
    - Migrate FastAPI from on_event to lifespan pattern
    - Register pytest custom markers (integration, slow, unit)
    - See: tasks/251104-task-12-fix-deprecation-warnings.txt

[DONE] Create task-13: Document embedding specifications everywhere
    - See: tasks/251104-task-13-document-embedding-specs.txt

[DONE] Update README.md with verified embedding model specifications
    - Added embedding models section with 6 VERIFIED WORKING LM Studio models
    - Corrected dimensions: qwen3-8b (4096-dim), qwen3-4b (2560-dim), qwen3-0.6b (1024-dim)
    - Added explicit note that jina-v4 does NOT work in LM Studio
    - Listed all working models with parameters and dimensions

[DONE] Update .env.example with verified LM Studio models
    - Changed default from jina-v4 to text-embedding-qwen3-embedding-8b (4096-dim)
    - Added all 6 verified working models with specifications
    - Added explicit warning that jina-v4 doesn't work
    - All models tested and confirmed working

[DONE] Verify test suite with correct dependencies
    - Upgraded SQLAlchemy to 2.0.44 (Python 3.13 compatible, fix in 2.0.39)
    - Upgraded requests to 2.32.5 (langchain-community compatible)
    - Updated requirements.txt: sqlalchemy>=2.0.35 → >=2.0.44, requests>=2.31.0 → >=2.32.5
    - Cleared pytest cache and __pycache__ to remove stale bytecode
    - Test collection succeeds: 449 tests collected
    - SDK unit tests: 16 of 17 passed (1 outdated test expectation, not a blocker)
    - NO SQLAlchemy Python 3.13 compatibility errors
    - All dependency issues resolved

[DONE] Task-12: Fix deprecation warnings
    - [DONE] Fixed SQLAlchemy declarative_base import (commit fc2bd3a)
    - [DONE] Migrated FastAPI from on_event to lifespan pattern (commit 63fb930)
    - [DONE] Registered pytest custom markers (integration, slow, unit) (commit 6741a1f)
    - NO SQLAlchemy or FastAPI deprecation warnings remaining
    - Only Pydantic v2 warning remains (out of scope for Task-12)

[DONE] Task-14: Layered architecture refactoring (Phase 1 analysis)
    - Break application into c0-c4 layers (one folder per layer)
    - Phase 1: Analysis complete (commit 0147dae)
    - Found 6 files over 1,000 lines requiring breakdown
    - 93 Python files, 29,308 total lines analyzed
    - Layer distribution planned: c0 (36), c1 (27), c2 (53), c3 (26), c4 (50)
    - See: tasks/251104-task-14-phase-01-analysis.txt
    - See: tasks/251104-task-14-layer-layout.txt (commit d6816ce)

[DONE] Task-15: Modular monolith organization analysis
    - Analyzed API endpoints for modular monolith structure
    - 17 modules proposed by HTTP prefix grouping
    - Module registry pattern designed
    - Integration with c0-c4 layers
    - See: tasks/251104-task-15-modular-monolith.txt (commit f3df788)

[DONE] Task-16: Corrected Python package naming convention
    - CRITICAL FIX: Python cannot use hyphens in package names
    - Changed all c1-database → c1_database (underscores)
    - Revised totals: 181 files in 37 packages
    - See: tasks/251104-task-16-corrected-naming.txt (commit f3df788)

[DONE] Task-17: Three-layer flat architecture with modular monolith (DESIGN COMPLETE)
    - **3 LAYERS: c1, c2, c3** (NOT c0-c4, NOT 5 layers)
    - **FLAT STRUCTURE**: All packages at src/ level, NO subfolders/nesting
    - **NAMING**: c{N}_{noun}_{module} pattern (e.g., c1_agent_models, c2_task_service)
    - **6 modular monoliths** (grouped from 17 original modules)
    - See: tasks/251104-task-17-three-layer-architecture.txt
    - Status: Design complete, comprehensive planning documents created

[DONE] Task-18: Comprehensive refactoring plan with stages
    - 6 stages with detailed substages (Stage 0-6)
    - Stage 1: Split 7 large files (6-8 hours)
    - Stage 2: Migrate c1 layer (4-6 hours)
    - Stage 3: Migrate c2 layer (6-8 hours)
    - Stage 4: Migrate c3 layer (4-6 hours)
    - Stage 5: Cleanup and validation (2-3 hours)
    - Stage 6: Merge and deploy (1 hour)
    - Total estimated: 24-34 hours
    - Testing after each file split, substage, and stage
    - Commit strategy: Frequent small commits with clear messages
    - Rollback strategy documented
    - See: tasks/251104-task-18-refactor-plan.txt

[DONE] Task-19: File-by-file destination mapping
    - Complete mapping of all 93 Python files to c1/c2/c3 destinations
    - Detailed split plans for 7 large files (database.py, server.py, etc.)
    - Destination comments template for marking files
    - Migration checklist template
    - Progress tracking file format
    - See: tasks/251104-task-19-file-mapping.txt

[DONE] Task-20: Validation scripts and testing strategy
    - Layer dependency validator (validate_architecture.py)
    - Import checker (check_imports.py)
    - Test coverage reporter (test_coverage.py)
    - Performance benchmark (benchmark.py)
    - Testing strategy: unit, integration, e2e, regression
    - CI/CD workflow (GitHub Actions)
    - Pre-commit hook
    - See: tasks/251104-task-20-validation-scripts.txt

[ACTIVE] Task-21: Execute refactoring (IN PROGRESS)
    - Prerequisites: All planning documents complete ✓
    - Dependency fixes committed (commit b4bbdb3) ✓
    - Test suite verified working (449 tests collect, 16/17 SDK tests pass) ✓
    - Current stage: Stage 0 (Preparation and setup)
    - Estimated: 24-34 hours total across 6 stages
    - Next immediate action: Create refactoring branch
    - See planning docs: tasks/251104-task-{17,18,19,20}-*.txt

## Immediate Actions

[DONE] Fix pip install dependency issues
    - LangChain dependency resolution conflicts - RESOLVED
    - Solution: Install LangChain 1.0.x series first with --no-deps
    - Working versions:
      - langchain==1.0.3
      - langchain-core==1.0.2
      - langchain-openai==1.0.1
      - langchain-community==0.4.1
    - Installation steps:
      1. pip install --no-deps langchain langchain-core langchain-openai
      2. pip install -r requirements.txt (installs remaining dependencies)
    - Key insight: --no-deps bypasses pip backtracking, installs latest compatible versions
    - Updated DEPENDENCY-ANALYSIS.txt with solution
    - Committed: 3a09cc4 "Resolve LangChain dependency conflicts with 1.0.x series"

[DONE] Initialize git repository
    - Repository already initialized
    - Remote configured: origin (git@github.com:kk-digital/Hephaestus.git)
    - Branch: dev-haltingstate-00

[ ] Push commits to GitHub
    - 3 commits ready to push (00d8cc6, 3a09cc4, 8a9d3d0)
    - BLOCKED: SSH keys need to be configured in container
    - Command: git push origin dev-haltingstate-00
    - After push, consider setting up Gogs remote for backup

[DONE] Commit task files and documentation
    - Task files created: 251101-task-01 through 251101-task-08 (8 tasks total)
    - Configuration files created: .env, testing-keys.txt, .gitignore
    - Documentation created: EMBEDDINGS-EXPLAINED.txt, DEPENDENCY-ANALYSIS.txt, etc.
    - All commits completed on dev-haltingstate-00 branch
    - Session summary created: SESSION-SUMMARY-251101.txt

## Task Files Created (Ready for Commit)

[DONE] 251101-task-01-embedding-migration.txt
    - Migrate to open-source embeddings (LM Studio, jina-v4, or OpenAI)
    - Three embedding options documented with implementation steps

[DONE] 251101-task-02-repo-reorganization.txt
    - Reorganize repository: Python code → code/, config → config/
    - Update imports and paths

[DONE] 251101-task-03-layer-refactoring.txt
    - Layer-based refactoring with c0-c4 prefixes
    - c0 (utils) → c1 (base) → c2 (core) → c3 (services) → c4 (apps)
    - Analysis scripts and migration plan

[DONE] 251101-task-04-test-organization.txt
    - Organize tests to match layer structure
    - tests/cN_layer/ directories mirror src/cN_layer/

[DONE] 251101-task-05-llm-service-abstraction.txt
    - Create C1 LLM service abstraction layer
    - Centralize all LLM operations in c1_llm_* modules
    - Support multiple providers (OpenRouter, OpenAI, Anthropic, Groq, Local)

[DONE] 251101-task-06-local-llmstudio-testing.txt
    - Run Hephaestus completely with LM Studio for local testing
    - Use small models (qwen2.5-1.5b-instruct) for development
    - FREE testing without API costs

[DONE] 251101-task-07-langchain-isolation.txt
    - Isolate all LangChain usage in C1 wrapper module
    - Only c1_langchain_wrapper.py imports LangChain
    - Provides clean abstraction for rest of codebase
    - Makes LangChain version pinning easier
    - Facilitates future replacement or upgrade

## Documentation Created

[DONE] EMBEDDINGS-EXPLAINED.txt
    - Comprehensive explanation of embeddings in Hephaestus
    - Why OpenAI is needed, cost estimates, alternatives

[DONE] LMSTUDIO-EMBEDDINGS.txt
    - Guide for using LM Studio embeddings instead of OpenAI
    - Migration steps, code changes, trade-offs

[DONE] OPEN-SOURCE-EMBEDDINGS-3072.txt
    - Analysis of open-source embedding landscape
    - NO 3072-dim models exist, best options: 768/1024/2048-dim

[DONE] TASK-FILE-FORMAT.txt
    - Task file naming conventions and format specification

[DONE] RENAME-TO-LOWERCASE.txt
    - Documentation about keeping "Hephaestus" with capital H

## Configuration Files Created

[DONE] .env
    - OpenAI API key configured
    - OpenRouter API key configured

[DONE] testing-keys.txt
    - Reference copy of API keys for testing

[DONE] .gitignore
    - Protect secrets (.env, testing-keys.txt)
    - Ignore Python artifacts, IDE files, logs, qdrant_storage/

[DONE] .claude/CLAUDE.md
    - Local development guidelines
    - Work inside container at /home/user/workspace/Hephaestus/
    - todo.txt and tasks/ locations documented
    - Session start/end checklists

## Cleanup and Organization

[ ] Clean up project folder - move documentation files to proper locations
    - Create /cleanup/ directory for temporary/one-time cleanup files
    - Create /reports/ directory for analysis reports and documentation
    - Move scattered documentation files from docker-hephaestus/ to proper locations
    - Organize: EMBEDDINGS-EXPLAINED.txt, LMSTUDIO-EMBEDDINGS.txt, etc.

## Testing and Verification

[ ] Verify test suite runs successfully
    - Check if pytest is installed in .venv
    - Run pytest to see current test status
    - Identify any failing tests
    - Document test coverage
    - Fix any broken tests if needed
    - Verify all tests pass before refactoring
    - Create baseline test report for comparison after refactoring

## Next Steps After Git Setup

1. Initialize git repository
2. Create .gitignore (already done)
3. Initial commit with task files and documentation
4. Create dev-haltingstate-00 branch
5. Push to GitHub remote: kk-digital/Hephaestus
6. Fix pip install issues
7. Run test suite to establish baseline
8. Begin refactoring work following task files

## Dependencies and Blockers

BLOCKER: pip install failing on LangChain dependencies
  - Needs resolution before proceeding with development
  - May need to simplify requirements or pin versions
  - Consider removing or replacing problematic dependencies

BLOCKER: Repository not initialized with git
  - Prevents committing and pushing work
  - Easy fix: git init && git remote add origin [url]

## Notes

- Development happens inside Docker container at /home/user/workspace/Hephaestus/
- SSH into container: ssh user@localhost -p 2224
- Git branch: dev-haltingstate-00 (for development)
- Task files use naming: yymmdd-task-NN-description.txt
- Status suffixes: .done.txt (completed), .failed.txt (failed)
