HEPHAESTUS DEPENDENCY ANALYSIS
===============================

Date: 2025-11-01
Issue: LangChain dependency resolution conflicts
Status: RESOLVED - Using 1.0.x series with --no-deps workaround

SOLUTION (SUCCESSFUL)
---------------------

The issue was resolved by installing LangChain packages FIRST without dependencies,
then installing the rest of requirements.txt.

Working versions (LangChain 1.0.x series):
- langchain==1.0.3
- langchain-core==1.0.2
- langchain-openai==1.0.1
- langchain-community==0.4.1
- langchain-groq>=0.0.1

Installation steps:
1. pip install --no-deps langchain langchain-core langchain-openai
2. pip install -r requirements.txt (installs remaining deps)

Key insight: Using --no-deps bypasses pip's backtracking resolver and installs
the latest 1.0.x versions which are all mutually compatible.

NOTE: Using langchain[llms] extras does NOT solve the issue - it still triggers
the same backtracking behavior because it doesn't change version constraints.

PROBLEM SUMMARY
---------------

pip install fails due to conflicting LangChain package version requirements.
pip enters backtracking mode trying 100+ version combinations.

ROOT CAUSE
----------

LangChain ecosystem has complex interdependencies:
- langchain (main package)
- langchain-core (shared utilities)
- langchain-openai (OpenAI integration)
- langchain-community (community integrations)
- langchain-groq (Groq integration)

Version constraints conflict:
- Different langchain-* packages require different langchain-core versions
- Some require <0.2, others require >=0.2.43
- Cannot satisfy all constraints simultaneously

REQUIREMENTS BREAKDOWN
----------------------

### Core Dependencies (29 packages)

1. Web Framework:
   - fastapi>=0.115.5
   - uvicorn[standard]>=0.32.1

2. Database:
   - sqlalchemy==2.0.23
   - alembic==1.13.0 (migrations)

3. Vector Database:
   - qdrant-client>=1.12.0

4. LLM APIs:
   - openai>=1.12.0,<2.0.0
   - anthropic==0.42.0

5. Data Validation:
   - pydantic>=2.11.0
   - pydantic-settings>=2.7.0

6. Async/HTTP:
   - anyio>=4.11.0
   - httpx>=0.27.0,<0.29.0
   - aiohttp (via langchain)
   - websockets==13.0

7. MCP Protocol:
   - mcp>=1.18.0

8. File I/O:
   - aiofiles==23.2.1

9. Configuration:
   - python-dotenv==1.0.0
   - pyyaml==6.0.1

10. Monitoring:
    - watchdog==3.0.0
    - prometheus-client==0.19.0
    - structlog==23.2.0

11. Utilities:
    - requests==2.31.0
    - tenacity==8.2.3 (retries)
    - libtmux==0.23.2

12. UI:
    - textual==0.47.1
    - rich==13.7.0

13. LangChain (PROBLEMATIC):
    - langchain>=0.1.0
    - langchain-openai>=0.0.5
    - langchain-community>=0.0.10
    - langchain-groq>=0.0.1

ATTEMPTED SOLUTIONS
-------------------

Attempt 1: Pin to langchain 0.2.17
- langchain==0.2.17
- langchain-core==0.2.40
- langchain-openai==0.0.5
- langchain-community==0.0.10
Result: FAILED - langchain 0.2.17 requires langchain-core>=0.2.43

Attempt 2: Update core to 0.2.43
- langchain==0.2.17
- langchain-core==0.2.43
- langchain-openai==0.0.5
- langchain-community==0.0.10
Result: FAILED - langchain-openai 0.0.5 requires langchain-core<0.2

Attempt 3: Update openai to 0.2.0
- langchain==0.2.17
- langchain-openai==0.2.0
- langchain-community==0.0.10
- langchain-core==0.2.43
Result: FAILED - still conflicts

Attempt 4: Update all to 0.2.x
- langchain==0.2.17
- langchain-openai==0.2.0
- langchain-community==0.2.0
- langchain-groq==0.0.1
Result: FAILED - internal conflicts remain

RECOMMENDED SOLUTIONS
---------------------

Option 1: Use Latest Compatible Versions (RECOMMENDED)
- Remove version pins
- Let pip resolve to latest compatible versions
- Accept that backtracking may take 5-10 minutes
- Once resolved, freeze versions with pip freeze

Commands:
  cd /home/user/workspace/Hephaestus/Hephaestus
  .venv/bin/pip install -r requirements.txt --timeout 600
  # Wait for resolution (may take 10+ minutes)
  .venv/bin/pip freeze > requirements-frozen.txt
  # Use requirements-frozen.txt for future installs

Option 2: Remove LangChain Entirely
- Consider if LangChain is actually needed
- Many of its features can be implemented directly:
  - Chat completions: Use openai/anthropic SDKs directly
  - Prompt templates: Simple string formatting
  - Chains: Custom Python functions
  - Memory: Custom implementation with Qdrant
- Benefits: Simpler dependencies, faster installs, more control

Steps:
  1. Audit what LangChain features are actually used
  2. Implement alternatives for each feature
  3. Remove langchain-* from requirements.txt
  4. Follow Task-07 to wrap any remaining usage

Option 3: Use Docker with Pre-built Environment
- Create Dockerfile with working dependency set
- Build image with all dependencies installed
- Avoids dependency resolution on every install
- Reproducible environment

Example Dockerfile:
  FROM python:3.13-slim
  WORKDIR /app
  COPY requirements.txt .
  RUN pip install --no-cache-dir -r requirements.txt
  # Rest of application setup...

Option 4: Use Poetry or PDM
- Modern dependency managers with better resolution
- Lock files ensure reproducible installs
- Better conflict reporting

Commands:
  poetry init
  poetry add <packages>
  poetry lock
  poetry install

DEPENDENCY SIZE ESTIMATES
-------------------------

Total package count: ~150-200 packages (including transitive deps)

Estimated sizes (from typical Python installs):
- LangChain ecosystem: ~100-150 MB
  - langchain: 20-30 MB
  - langchain-core: 10-20 MB
  - langchain-openai: 5-10 MB
  - langchain-community: 50-80 MB (many integrations)
  - Dependencies (tiktoken, dataclasses-json, etc.): 20-30 MB

- ML/Vector packages: ~150-300 MB
  - numpy: 20-30 MB
  - qdrant-client: 10-20 MB
  - grpcio: 20-30 MB

- Web framework: ~20-30 MB
  - fastapi: 5-10 MB
  - uvicorn: 5-10 MB
  - starlette: 5-10 MB

- LLM SDKs: ~10-20 MB
  - openai: 5-10 MB
  - anthropic: 5-10 MB

- Other dependencies: ~50-100 MB

Total estimated install size: 350-600 MB

LANGCHAIN USAGE AUDIT
---------------------

Before deciding on solution, audit actual LangChain usage:

Files to check:
  grep -r "from langchain" src/
  grep -r "import langchain" src/

Common LangChain features used in projects:
1. LLMs (language models)
   - Alternative: Use openai/anthropic SDKs directly
2. Prompt templates
   - Alternative: f-strings or Jinja2
3. Chains
   - Alternative: Custom Python functions
4. Agents
   - Alternative: Custom agent logic
5. Memory
   - Alternative: Custom memory with Qdrant
6. Document loaders
   - Alternative: Custom loaders
7. Text splitters
   - Alternative: Simple chunking functions

NEXT STEPS
----------

1. Choose solution approach:
   [ ] Option 1: Wait for pip resolution (10+ minutes)
   [ ] Option 2: Remove LangChain, implement alternatives
   [ ] Option 3: Use Docker with pre-built image
   [ ] Option 4: Migrate to Poetry/PDM

2. If keeping LangChain:
   [ ] Run pip install with long timeout (10+ minutes)
   [ ] Capture resolved versions with pip freeze
   [ ] Create requirements-frozen.txt for future use
   [ ] Document which LangChain features are used

3. If removing LangChain:
   [ ] Audit LangChain usage in codebase
   [ ] Implement alternatives for each feature
   [ ] Remove langchain-* from requirements.txt
   [ ] Test all functionality works without LangChain

4. Follow Task-07:
   [ ] Isolate remaining LangChain usage in wrapper module
   [ ] Makes future migration easier

CONCLUSION
----------

LangChain dependency resolution is complex and time-consuming.
Consider whether LangChain is necessary for this project.
Many of its features can be implemented more simply without it.

If keeping LangChain:
- Accept 10+ minute install times
- Use requirements-frozen.txt to lock working versions
- Follow Task-07 to isolate usage for easier future migration

If removing LangChain:
- Implement simple alternatives for used features
- Faster installs, simpler dependencies
- More control over implementation
